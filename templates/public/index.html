{% extends "../base.html" %}

{% block body %}
  <div class="row">
    <div class="col-md-6">
      {{ err }}
      {{ msg }}

      {% if not current_user %}
        <h2>Welcome to Ansatz!</h2>

        <p>
          Ansatz is a simple way to find someone's email address while still respecting their privacy. 
          </br></br>
          It works like this:</br>
          If I search the database for "Alexander Pease" at "Union Square Ventures", I'll find an entry for 
          "a********@usv.com". Ansatz lets me send him an email directly to his inbox while still keeping his address private.
          If he chooses to respond, then I'll know his real email address. 
        </p>

        To find someone, <a href="/auth/google">login w/ your Gmail account</a>

      {% else %}
        Welcome {{ current_user_name() }} 

        {% if current_user_staff() %}
          <a href="/admin">admin</a>
        {% end %}

        <form class="form-horizontal" action="/" method="GET">
          <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">Name</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="name" placeholder="Ex: Alexander Pease">
            </div>
          </div>
          
          <div class="form-group">
            <label for="inputPassword3" class="col-sm-2 control-label">Domain</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="domain" placeholder="Ex: domain.com">
            </div>
          </div>

          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
              <button type="submit" class="btn btn-primary">Search</button>
            </div>
          </div>
        </form>

        {% if results %}

          In Your Network: 
          <table class="table table-striped">
              <tr>
                <th>Name</th>
                <th>Total Emails In</th>
                <th>Latest Email In</th>
                <th>Total Emails Out</th>
                <th>Latest Email Out</th>
              </tr>

              <tr class="account_row" id="test_id" style="display:none">  
                <td>
                  Alexander Pease (alexander@usv.com)
                </td>
                <td class="account_row_total_emails_in">
                  loading...
                </td>
                <td class="account_row_latest_email_in">
                  
                </td>
                <td class="account_row_total_emails_out">
                  
                </td>
                <td class="account_row_latest_email_out">
                  
                </td>
              </tr>
          </table>







          {% if results is 'empty' %}
            No results found, try another search!
          {% else %}
            Global Database:
            <table class="table table-striped">
              <tr>
                <th>Profile</th>
                <th>Public Email Address</th>
              </tr>
              {% for r in results %}
                <tr>
                  <td>{{ r.name }} ({{ email_obscure(r) }})</td>
                  <td><a href="mailto:{{ r.burner }}@ansatz.me" target="_blank">{{ r.burner }}@ansatz.me</a></td>
                </tr>
              {% end %}
            </table>
          {% end %}
        {% end %}


      {% end %} <!--current user-->
    </div><!--col-md-6-->
  </div><!--row-->
{% end %}

{% block javascript %}
    <!-- Script for querying GMail API through our API --> 
    <script>
    // Queries API for all accounts on page load
    $(document).ready(function() {
      $('.account_row').each(function() {
        var query = window.location.href.split("domain=")[1];
        if (query) {
          $(this).show();
          var url = "api/gmailinboxsearch?";
          url += "q=" + query; 
          url += "&u=" + $(this).attr('id');

          console.log("Querying " + url);
          $.ajax(url, {
                error: function(jqxhr, status, error) {
                  console.log("Error: " + error);
                },
                success: function(data, status, jqxhr) {
                  updateRow(data);
                }
              });
        }
      });
    });

    // Updates row upon successful API call
    function updateRow(data) {
      correspondence = data['data'];
      console.log(correspondence);
      //name = correspondence['name'];
      name = '#test_id';
      $(name).children('.account_row_total_emails_in').text(correspondence['total_emails_in']);
      $(name).children('.account_row_latest_email_in').text(correspondence['latest_email_in_date']);
      $(name).children('.account_row_total_emails_out').text(correspondence['total_emails_out']);
      $(name).children('.account_row_latest_email_out').text(correspondence['latest_email_out_date']);
      /*
      if (correspondence['err'] == 'not logged in'){
        $('#' + name).children('.account_row_total_emails_in').text("You're not logged in! Go log in at USV.com");
      }
      else if (correspondence['err'] == 'error login') {
        $('#' + name).children('.account_row_total_emails_in').text('Error logging into inbox');
      }
      else if (correspondence['err'] == 'no results') {
        $('#' + name).children('.account_row_total_emails_in').text(0);
        $('#' + name).children('.account_row_latest_email_in').text('N/A');
        $('#' + name).children('.account_row_total_emails_out').text(0);
        $('#' + name).children('.account_row_latest_email_out').text('N/A');
      }
      */
    }

    function jq( myid ) {
      return "#" + myid.replace( /(:|\.|\[|\])/g, "\\$1" );
    }


  </script>


{% end %}
