{% extends "../base.html" %}
{% block page-title %}Home{% end %}
{% block page-description %}Ansatz is a simple way to find someone's email address while still respecting their privacy.{% end %}

{% block body %}
      {{ err }}
      {{ msg }}

      <section class="feature">
        <form id="main-search" class="form-horizontal container" action="/search" method="GET">
          <div class="row">
            <div class="input-group-lg col-sm-4 col-lg-4 col-xs-12">
              <input name="name" type="text" class="form-control" placeholder="Name">
            </div>
            <div class="input-group input-group-lg col-sm-4 col-lg-4 col-xs-12">
              <span class="input-group-addon">@</span>
              <input name="domain" type="text" class="form-control" placeholder="Domain">
            </div>
            <div class="col-sm-4 col-lg-4 col-xs-12 search-btn-wrap">
              <button type="submit" class="btn btn-primary">Search</button>
            </div>
          </div>
        </form>
      </section>


      {% if group_connection_set or profile_connection_set %}
      <section class="feature">
        <div class="container">
          <h3>Team Results</h3> 

          <!-- Nav tabs on top of results table -->
          <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
              <a href="#GroupConnections" role="tab" data-toggle="tab">By Teammate</a>
            </li>
            <li role="presentation">
              <a href="#ProfileConnections" role="tab" data-toggle="tab">By Connection</a>
            </li>
          </ul>

          <!-- Tab panes -->
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="GroupConnections">
              <!-- Table for GroupConnections -->
                <table class="table table-condensed table-hover">
                  <thead>
                    <tr>
                      <th>Teammate</th>
                      <th>Connection</th>
                      <th>Most Recently</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for sc in group_connection_set %}
                      {% set first = True %}
                      {% for c in sc.connections %}
                        <tr id="popover-row" data-container="body" data-content="{{ sc.email }} --> {{ c.profile.email}}:</br>{{ c.total_emails_out }} total emails, most recently on {{ c.latest_email_out_date_string() }}</br></br>{{ c.profile.email}} --> {{ sc.email }}:</br>{{ c.total_emails_in }} total emails, most recently on {{ c.latest_email_in_date_string() }}">
                          
                          {% if first %}
                            {% if sc.email == current_user %}
                              You
                            {% else %}
                              <td>{{ sc.name }} (<a href="mailto:{{ sc.email }}">{{ sc.email }}</a>) emailed...</td>
                            {% end %}
                          {% else %}
                            <td></td>
                          {% end %}
                          <td>
                            {% set days_since_emailed_out = c.days_since_emailed_out() %}
                             {{ c.profile.name }} (<a href="mailto:{{ c.profile.email }}">{{ c.profile.email }}</a>)...
                          </td>
                          <td> 
                            {% if days_since_emailed_out == 'Today' %}
                              Today
                            {% elif days_since_emailed_out %}
                                {{ days_since_emailed_out }} days ago
                            {% else %}
                              N/A
                            {% end %}
                          </td>
                        </tr>

                        {% set first = False %}
                      {% end %} <!-- c in sc.connections -->
                    {% end %} <!-- sc in group_connection_set -->
                  </tbody>
                </table>
              <!-- End table for GroupConnections -->
            </div>
            
            <div role="tabpanel" class="tab-pane" id="ProfileConnections">
              <!-- Table for GroupConnections -->
              <table class="table table-condensed table-hover">
                <thead>
                  <tr>
                    <th>Connection</th>
                    <th>Teammates</th>
                  </tr>
                </thead>
                <tbody>
                  {% for sc in profile_connection_set %}
                    {% set first = True %}
                    {% for c in sc.connections %}
                      <tr id="popover-row" data-container="body" data-content="{{ sc.email }} --> {{ c.user.email}}:</br>{{ c.total_emails_in }} total emails, most recently on {{ c.latest_email_in_date_string() }}</br></br>{{ c.user.email}} --> {{ sc.email }}:</br>{{ c.total_emails_out }} total emails, most recently on {{ c.latest_email_out_date_string() }}">
                        {% if first %}
                          <td>{{ sc.name }} (<a href="mailto:{{ sc.email }}">{{ sc.email }}</a>) emailed...</td>
                        {% else %}
                          <td></td>
                        {% end %}
                        <td>
                          {% set days_since_emailed_in = c.days_since_emailed_in() %}
                          {{ c.user.name }} (<a href="mailto:{{ c.user.email }}">{{ c.user.email }}</a>) 
                          {% if days_since_emailed_in == 'Today' %}
                            Today
                          {% elif days_since_emailed_in == 1 %}
                              {{ days_since_emailed_in }} day ago
                          {% elif days_since_emailed_in %}
                            {{ days_since_emailed_in }} days ago
                          {% else %}
                            N/A
                          {% end %}
                        </td>
                      </tr>
                      {% set first = False %}
                    {% end %} <!-- c in sc.connections -->
                  {% end %} <!-- sc in profile_connection_set -->
                </tbody>
              </table>
              <!-- End table for GroupConnections -->
            </div>
          </div>
        </div>
      </section>
      {% end %}


      {% if profiles %}
      <section class="feature">
        <div class="container">
          <h3>Other search results:</h3>
          (People you're not connected to, but we enable you to send them an email directly to their inbox!)
            {% if profiles is 'empty' %}
              <p>No results found, try another search!</p>
            {% else %}
              <table class="table table-striped">
                <tr>
                  <th>Profile</th>
                  <th>Public Email Address</th>
                </tr>
                {% for p in profiles %}
                  <tr>
                    <td>{{ p.name }} ({{ email_obscure(p) }})</td>
                    <td><a href="mailto:{{ p.burner }}@ansatz.me" target="_blank">{{ p.burner }}@ansatz.me</a></td>
                  </tr>
                {% end %}
              </table>
            {% end %}
          </div>
        </section>
      {% end %}
      </section>
{% end %}

{% block javascript %}
  <script>
    $(document).ready(function(){
      $('body').popover({
        placement: "top",
        trigger: "hover",
        selector: "tr[id=popover-row]",
        container: "body",
        html: true,
        template: '<div class="popover popover-medium"><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>'
      });
    });
  </script>
{% end %}
