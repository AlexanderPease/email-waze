{% extends "../base.html" %}
{% block page-title %}Settings{% end %}
{% block page-description %}Ansatz is a simple way to find someone's email address while still respecting their privacy.{% end %}
{% block body %}
  <div class="row">
    <div class="col-md-6">

      {% if msg %}
        {{ msg }}</br>
      {% end %}

      {% if err %}
        {{ msg }}</br>
      {% end %}

      Settings for {{ user.casual_name() }}
      </br></br>

      Email: {{ user.email }}
      </br>

      Ansatz email: {{ profile.burner }}@{{ settings.get('domain_name') }}
      </br></br>
      <!--<ul>
        <li>Update your Ansatz email</li>
      </ul>-->

      <a href="/group/create">Create a new team</a>
      </br>

      {% if groups %}
        Teams: 
        <ul>
          {% for g in groups %}
            <li> 
              {% if current_user == g.admin.email %}
                <a href="/group/{{ g.id }}/edit">{{ g }}</a>
              {% else %}
                {{ g }}
              {% end %}

              ({{ len(g.users) }} members): 
              {% for u in g.users %}
                {{ u.name }} ({{ u.email }}), 
              {% end %}
            </li>
          {% end %}
        </ul>
      {% else %}
        You're not yet in any teams! Teams are a great way to collaborate
        with friends or coworkers while expanding your address book. </br>
      {% end %}

      {% if group_invites %}
        You have pending invites to these teams:
        <ul>
          {% for g in group_invites %}
            <li>{{ g }} ({{ len(g.users) }} members): 
              {% for u in g.users %}
                {{ u.name }} ({{ u.email }}), 
              {% end %}
              - <a href="/group/{{ g.id }}/acceptinvite">Accept invitation</a>
            </li>
          {% end %}
        </ul>
      {% end %}

      {% if 0 %}
        Billing info:</br>
        All teams up to 5 users are free! 

        {% if paying_groups %}
          You are the admin of {{ len(paying_groups) }} team ({{ list_to_comma_delimited_string(paying_groups) }}) that qualifies for our Basic tier of $5/month for each user.
        {% else %}
          None of your teams exceed the free tier, but you can update your billing info if you'd like. 
        {% end %}

        </br>
        <button id="stripeButton" trype="button" class="btn-primary">
          {% if user.stripe_id %}
            Update Billing Info
          {% else %}
            Enter Billing Info
          {% end %}
        </button>
      {% end %}


    </div><!--col-md-6-->
  </div><!--row-->

{% end %}

{% block javascript %}
<script src="https://checkout.stripe.com/checkout.js"></script>
<script>
  var ROOT_URL = 'http://localhost:8001/';

  var handler = StripeCheckout.configure({
    key: 'pk_test_RMlPjQ0uu36oDd6TRWXSFmWh',
    image: '/square-image.png',
    token: function(token) {
      // Use the token to create the charge with a server-side script.
      // You can access the token ID with `token.id`
      //$('#stripeButton').attr('disabled', true);
      //$('#stripeButton').removeClass('btn-primary').addClass('btn-success');
      var options = {
          type: 'POST',
          url: ROOT_URL + 'stripe/basic?token_id=' + token.id + '&email=' + token.email,
          dataType: 'json',
          success: function(response) {
              console.log(response);
          },
          error: function(response) {
              console.warn(response);
          }
      };
      console.log('Requesting: ' + options.url)
      $.ajax(options);
    }
  });

  document.getElementById('stripeButton').addEventListener('click', function(e) {
    // Open Checkout with further options
    handler.open({
      name: '{{ settings.get("company_name") }}',
      description: 'Monthly subscription billing info',
      email: '{{ user.email }}',
      panelLabel: "Update Card"
    });
    e.preventDefault();
  });
</script>
{% end %}
